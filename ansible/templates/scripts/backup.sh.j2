#!/bin/sh

systemctl stop minecraft

sudo -u minecraft sh -c "yes 'y' | borg create --compression zstd{% if use_bluemap %} --pattern=+server/bluemap/web/data/markers.json --pattern=-server/bluemap{% endif %} --pattern=-server/cache backup::\"$(date -I'minutes')\" server"
sudo -u minecraft borg prune --keep-within {{ backup_retention_days }}d --save-space backup
tar cf - backup/ | oci os object put --auth instance_principal --bucket-name {{ bucket_name }} --file - --name "minecraft.tar" --force

systemctl start minecraft
