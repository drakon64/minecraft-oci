#!/bin/sh

printf "Server closed for backup." > server/stop
sudo systemctl stop minecraft
rm server/stop

cp -pr --reflink=always server/ server-backup/

if [ "$1" = "restart" ]
then
	sudo systemctl start minecraft
fi

SCRIPT_PWD=$(pwd)
cd server-backup || exit 1
yes 'y' | borg create --compression zstd{% if use_bluemap %} --pattern=+bluemap/web/data/markers.json --pattern=-bluemap{% endif %} --pattern=-cache "$SCRIPT_PWD"/backup::"$(date -I'minutes')" .
cd "$SCRIPT_PWD" || exit 1
rm -fr server-backup

borg prune --keep-within {{ backup_retention_days }}d --save-space backup

tar cf - backup/ | oci os object put --auth instance_principal --bucket-name {{ bucket_name }} --file - --name "minecraft.tar" --force
