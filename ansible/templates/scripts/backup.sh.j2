#!/bin/sh

systemctl stop minecraft

cp -pr --reflink=always server/ server-backup/

systemctl start minecraft

PWD=$(pwd)
cd server-backup || exit 1
sudo -u minecraft sh -c "yes 'y' | borg create --compression zstd{% if use_bluemap %} --pattern=+bluemap/web/data/markers.json --pattern=-bluemap{% endif %} --pattern=-cache $PWD/backup::\"$(date -I'minutes')\" ."
cd "$PWD" || exit 1
rm -rf server-backup

sudo -u minecraft borg prune --keep-within {{ backup_retention_days }}d --save-space backup

tar cf - backup/ | oci os object put --auth instance_principal --bucket-name {{ bucket_name }} --file - --name "minecraft.tar" --force
