#!/bin/sh

DATE=$(date -I'minutes')

printf "Server closed for backup." > $1/server/stop
sudo systemctl stop minecraft
rm $1/server/stop

cp -pr --reflink=always $1/server/ $1/server-backup/

if [ "$2" = "restart" ]
then
	sudo systemctl start minecraft
fi

SCRIPT_PWD=$(pwd)
cd $1/server-backup || exit 1
yes 'y' | borg create --compression zstd{% if bluemap.use %} --pattern=+bluemap.use/web/data/markers.json --pattern=-bluemap.use{% endif %} --pattern=-cache "$SCRIPT_PWD"/$1/backup::"$DATE" .
cd "$SCRIPT_PWD" || exit 1
rm -fr $1/server-backup

borg prune --keep-within {{ backup_retention_days }}d --save-space $1/backup

cd $1 || exit
tar cf - backup/ | oci os object put --auth instance_principal --bucket-name {{ bucket_name }} --file - --name "minecraft.tar" --force
