#!/bin/sh

systemctl stop minecraft

sudo -u minecraft sh -c "yes 'y' | borg create --exclude server/bluemap --exclude server/cache --compression zstd backup::\"$(date -I'minutes')\" server"
sudo -u minecraft borg prune --keep-daily {{ backup_retendion_days }} --save-space backup
tar cf - backup/ | oci os object put --auth instance_principal --bucket-name {{ bucket_name }} --file - --name "minecraft.tar" --force

systemctl start minecraft
